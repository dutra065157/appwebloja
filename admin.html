<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Administrativo - Gra√ßa Presentes</title>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link rel="stylesheet" href="style/style.css" />
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header
      class="gradient-bg shadow-sm sticky top-0 z-50 backdrop-blur-sm bg-white/95"
    >
      <div
        class="container mx-auto px-4 py-3 flex justify-between items-center"
      >
        <!-- Logo -->
        <div class="flex items-center">
          <div
            class="w-12 h-12 rounded-full bg-pink-100 flex items-center justify-center mr-3 transition-transform hover:scale-105"
          >
            <i data-feather="gift" class="text-pink-600 w-6 h-6"></i>
          </div>
          <h1 class="text-2xl font-bold text-pink-600 font-serif">
            Gra√ßa Presentes
          </h1>
        </div>

        <nav class="hidden md:block">
          <ul class="flex space-x-8">
            <li>
              <a
                href="javascript:void(0)"
                onclick="fazerLogout()"
                class="nav-link font-medium hover:text-pink-600 transition"
                >Sair</a
              >
            </li>
            <li>
              <a
                href="produtos.html"
                class="nav-link font-medium hover:text-pink-600 transition"
                >Ver Loja</a
              >
            </li>
          </ul>
        </nav>

        <!-- Mobile Menu Button -->
        <button
          class="md:hidden p-2 rounded-full hover:bg-pink-100 transition"
          id="mobile-menu-button"
        >
          <i data-feather="menu"></i>
        </button>
      </div>

      <!-- Mobile Menu -->
      <div
        class="md:hidden hidden bg-white/95 backdrop-blur-sm shadow-xl border-t"
        id="mobile-menu"
      >
        <div class="container mx-auto px-4 py-4">
          <ul class="space-y-3">
            <li>
              <a
                href="produtos.html"
                class="block py-3 font-medium text-gray-600 hover:text-pink-600 transition pl-4"
                >Ver Loja</a
              >
            </li>
            <li>
              <a
                href="javascript:void(0)"
                onclick="fazerLogout()"
                class="block py-3 font-medium text-gray-600 hover:text-pink-600 transition pl-4"
                >Sair</a
              >
            </li>
          </ul>
        </div>
      </div>
    </header>

    <div class="container mx-auto px-4 py-8">
      <!-- Cabe√ßalho -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-pink-600">üéÅ Gra√ßa Presentes</h1>
        <p class="text-gray-600">
          Painel Administrativo - Cadastro de Produtos
        </p>
      </div>

      <!-- Formul√°rio de Cadastro -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">
          ‚ûï Adicionar Novo Produto
        </h2>

        <form id="produtoForm" class="space-y-6">
          <!-- Informa√ß√µes B√°sicas -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >üìù Nome do Produto *</label
              >
              <input
                type="text"
                name="nome"
                required
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                placeholder="Ex: Buqu√™ de Rosas Vermelhas"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >üìÇ Categoria *</label
              >
              <select
                name="categoria"
                required
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
              >
                <option value="">Selecione uma categoria</option>
                <option value="Perfumes">üå∑ Perfumes</option>
                <option value="Doces">üç´ Doces</option>
                <option value="Pel√∫cias">üß∏ Pel√∫cias</option>
                <option value="Cosm√©ticos">üíÑ Cosm√©ticos</option>
                <option value="Kits">üéÅ Kits</option>
                <option value="Decora√ß√£o">üè† Decora√ß√£o</option>
                <option value="Maquiagem">üíã Maquiagem</option>
                <option value="Rom√¢nticos">‚ù§Ô∏è Rom√¢nticos</option>
              </select>
            </div>
          </div>

          <!-- Pre√ßos -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >üí∞ Pre√ßo (R$) *</label
              >
              <input
                type="number"
                step="0.01"
                name="preco"
                required
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                placeholder="89.90"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >üè∑Ô∏è Pre√ßo Original (opcional)</label
              >
              <input
                type="number"
                step="0.01"
                name="precoOriginal"
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                placeholder="99.90"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >üéØ Desconto (%)</label
              >
              <input
                type="number"
                name="desconto"
                min="0"
                max="100"
                value="0"
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
              />
            </div>
          </div>

          <!-- Descri√ß√£o -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >üìÑ Descri√ß√£o do Produto</label
            >
            <textarea
              name="descricao"
              rows="3"
              class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
              placeholder="Descreva o produto detalhadamente..."
            ></textarea>
          </div>

          <!-- Upload de Imagem -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >üñºÔ∏è Imagens do Produto (M√°x: 3)</label
            >
            <div
              class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center transition-colors hover:border-pink-400"
            >
              <input
                type="file"
                id="imagemInput"
                accept="image/*"
                multiple
                class="hidden"
                onchange="previewImagem(event)"
              />

              <div id="uploadArea" class="cursor-pointer">
                <div class="mx-auto w-12 h-12 text-gray-400 mb-3">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                    ></path>
                  </svg>
                </div>
                <p class="text-gray-600">
                  Clique para selecionar at√© 3 imagens
                </p>
                <p class="text-sm text-gray-500 mt-1">PNG, JPG, JPEG</p>
              </div>

              <!-- Preview da Imagem -->
              <div
                id="previewContainer"
                class="hidden mt-4 grid grid-cols-3 gap-2"
              >
                <!-- Previews ser√£o inseridos aqui via JS -->
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2">
              Dica: Recomendado imagem quadrada (1:1), ex: 800x800px (Max:
              500KB)
            </p>
          </div>

          <!-- Op√ß√µes -->
          <div class="flex items-center space-x-6">
            <div class="flex items-center">
              <input
                type="checkbox"
                name="novo"
                id="novo"
                class="w-4 h-4 text-pink-600 focus:ring-pink-500"
              />
              <label for="novo" class="ml-2 text-sm text-gray-700"
                >üÜï Produto Novo</label
              >
            </div>

            <div class="flex items-center">
              <input
                type="checkbox"
                name="maisVendido"
                id="maisVendido"
                class="w-4 h-4 text-pink-600 focus:ring-pink-500"
              />
              <label for="maisVendido" class="ml-2 text-sm text-gray-700"
                >üî• Mais Vendido</label
              >
            </div>
          </div>

          <!-- Bot√£o Submit -->
          <button
            type="submit"
            class="w-full bg-gradient-to-r from-pink-500 to-rose-500 text-white py-3 px-6 rounded-lg hover:from-pink-600 hover:to-rose-600 transition duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
          >
            üöÄ Cadastrar Produto
          </button>
        </form>
      </div>

      <!-- Lista de Produtos -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-semibold text-gray-800">
            üì¶ Produtos Cadastrados
          </h2>
          <div class="flex items-center space-x-3">
            <span
              id="totalProdutos"
              class="bg-pink-100 text-pink-800 px-3 py-1 rounded-full text-sm font-medium"
              >0 produtos</span
            >
          </div>
        </div>

        <div id="listaProdutos" class="space-y-4">
          <!-- Produtos ser√£o carregados aqui -->
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">üìù</div>
            <p>Nenhum produto cadastrado ainda</p>
          </div>
        </div>
      </div>

      <!-- Lista de Pedidos (NOVO) -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-semibold text-gray-800">
            üõí Pedidos Recebidos
          </h2>
          <div class="flex items-center space-x-4">
            <button
              onclick="deletarTodosPedidos()"
              class="text-red-500 hover:text-red-700 text-sm font-medium flex items-center transition-colors"
              title="Apagar todos os pedidos"
            >
              <i data-feather="trash-2" class="w-4 h-4 mr-1"></i> Limpar Tudo
            </button>
            <button
              onclick="carregarPedidos()"
              class="text-pink-600 hover:text-pink-800 text-sm font-medium flex items-center transition-colors"
            >
              <i data-feather="refresh-cw" class="w-4 h-4 mr-1"></i> Atualizar
              Lista
            </button>
          </div>
        </div>

        <div id="listaPedidos" class="space-y-4">
          <div class="text-center py-8 text-gray-500">
            <p>Carregando pedidos...</p>
          </div>
        </div>
      </div>
    </div>

    <style>
      /* Estilos para o preview da imagem */
      .image-preview-container {
        position: relative;
        display: inline-block;
      }
      .remove-image-btn {
        position: absolute;
        top: -10px;
        right: -10px;
        background-color: rgba(239, 68, 68, 0.9); /* red-500 */
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
    </style>

    <script>
      // Verificar se o usu√°rio est√° logado
      const adminToken = localStorage.getItem("admin_token");
      if (!adminToken) {
        // Redirecionar para tela de login se n√£o estiver logado
        window.location.href = "login.html";
      }

      feather.replace();

      // Vari√°vel para armazenar a imagem em Base64
      let imagensSelecionadas = [];

      // Fun√ß√£o para fazer logout seguro
      function fazerLogout() {
        // Remover token de autentica√ß√£o
        localStorage.removeItem("admin_token");

        // Limpar dados da sess√£o administrativa
        sessionStorage.clear();

        // Opcional: Limpar tamb√©m o carrinho (se quiser)
        // localStorage.removeItem('carrinho');

        // Redirecionar para a p√°gina inicial
        mostrarFeedback("üîí Saindo do sistema...", "info");
        setTimeout(() => {
          window.location.href = "index.html";
        }, 1000);
      }

      // Sistema de timeout de sess√£o (30 minutos)
      let idleTimer;
      function resetIdleTimer() {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(
          () => {
            // Verificar se ainda est√° autenticado
            const token = localStorage.getItem("admin_token");
            if (token) {
              mostrarFeedback(
                "‚è∞ Sess√£o expirada por inatividade. Redirecionando...",
                "warning",
              );
              setTimeout(() => {
                fazerLogout();
              }, 2000);
            }
          },
          30 * 60 * 1000,
        ); // 30 minutos
      }

      // Iniciar timer de inatividade ao carregar a p√°gina
      resetIdleTimer();

      // Resetar timer em eventos de intera√ß√£o
      ["click", "mousemove", "keypress", "scroll"].forEach((event) => {
        document.addEventListener(event, resetIdleTimer, { passive: true });
      });

      // Detectar quando a p√°gina perde o foco (usu√°rio sai)
      window.addEventListener("blur", function () {
        // N√£o fazer logout imediato, apenas registrar
        console.log("P√°gina perdeu foco");
      });

      // Detectar quando a p√°gina volta a ter foco
      window.addEventListener("focus", function () {
        // Verificar se o token ainda existe
        const token = localStorage.getItem("admin_token");
        if (!token) {
          mostrarFeedback(
            "üîí Sess√£o expirada. Redirecionando para login...",
            "warning",
          );
          setTimeout(() => {
            window.location.href = "login.html";
          }, 1500);
        } else {
          resetIdleTimer(); // Resetar timer de inatividade
        }
      });

      // Detectar quando o usu√°rio est√° saindo da p√°gina (fechando aba/janela)
      window.addEventListener("beforeunload", function (e) {
        // N√£o fazer nada especial para n√£o interferir na navega√ß√£o
        // O token permanecer√° no localStorage at√© expirar ou ser removido manualmente
      });

      // Fun√ß√µes para manipula√ß√£o de imagem
      function previewImagem(event) {
        const files = Array.from(event.target.files);

        if (imagensSelecionadas.length + files.length > 3) {
          mostrarFeedback("‚ùå Selecione no m√°ximo 3 imagens", "error");
          event.target.value = ""; // Limpa sele√ß√£o
          return;
        }

        imagensSelecionadas.push(...files);
        atualizarPreview();
        event.target.value = ""; // Limpa input para permitir novas sele√ß√µes
      }

      async function atualizarPreview() {
        const container = document.getElementById("previewContainer");
        container.innerHTML = "";

        if (imagensSelecionadas.length > 0) {
          container.classList.remove("hidden");
          document.getElementById("uploadArea").classList.add("hidden");
        } else {
          container.classList.add("hidden");
          document.getElementById("uploadArea").classList.remove("hidden");
          return;
        }

        // Helper para ler arquivo
        const readFile = (file) =>
          new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(file);
          });

        // Carregar todas as imagens
        const imageUrls = await Promise.all(imagensSelecionadas.map(readFile));

        imageUrls.forEach((url, index) => {
          const div = document.createElement("div");
          div.className = "image-preview-container relative h-24";
          div.innerHTML = `
                <img src="${url}" class="w-full h-full object-cover rounded-lg shadow-md">
                <div class="remove-image-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer shadow-sm" 
                     onclick="removerImagemIndividual(${index})">√ó</div>
            `;
          container.appendChild(div);
        });

        // Bot√£o para adicionar mais imagens (se menos de 3)
        if (imagensSelecionadas.length < 3) {
          const div = document.createElement("div");
          div.className =
            "h-24 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-pink-500 hover:text-pink-500 text-gray-400 transition-colors";
          div.innerHTML = `<i data-feather="plus" class="w-8 h-8"></i>`;
          div.onclick = () => document.getElementById("imagemInput").click();
          container.appendChild(div);
        }

        feather.replace();
      }

      function removerImagem() {
        imagensSelecionadas = [];
        document.getElementById("imagemInput").value = "";
        atualizarPreview();
      }

      // Fun√ß√£o auxiliar para limpar input (simplificada para este exemplo)
      window.removerImagemIndividual = function (index) {
        imagensSelecionadas.splice(index, 1);
        atualizarPreview();
      };

      // Permitir clicar na √°rea de upload
      document
        .getElementById("uploadArea")
        .addEventListener("click", function () {
          document.getElementById("imagemInput").click();
        });

      // Cadastrar produto
      document
        .getElementById("produtoForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const button = this.querySelector('button[type="submit"]');
          const originalText = button.innerHTML;
          button.innerHTML = "‚è≥ Cadastrando...";
          button.disabled = true;

          // Preparar FormData para envio (suporta arquivos e campos de texto)
          const formData = new FormData();
          const form = e.target;

          // Adicionar campos de texto
          formData.append("nome", form.nome.value);
          formData.append("categoria", form.categoria.value);
          formData.append("preco", form.preco.value);
          if (form.precoOriginal.value)
            formData.append("preco_original", form.precoOriginal.value);
          formData.append("desconto", form.desconto.value || 0);
          formData.append("descricao", form.descricao.value);

          // Adicionar booleanos
          formData.append("novo", document.getElementById("novo").checked);
          formData.append(
            "mais_vendido",
            document.getElementById("maisVendido").checked,
          );

          // Adicionar imagem se existir
          if (imagensSelecionadas.length > 0) {
            imagensSelecionadas.forEach((file) => {
              formData.append("imagens", file);
            });
          }

          try {
            // Usar a mesma URL da API que o index.html usa
            const baseUrl =
              typeof API_BASE_URL !== "undefined" ? API_BASE_URL : "";
            const url = `${baseUrl}/api/produtos`;

            // Enviar dados do produto para a API
            const response = await fetch(url, {
              method: "POST",
              headers: {
                // N√£o definir Content-Type, o browser define multipart/form-data com boundary automaticamente
                Authorization: `Bearer ${adminToken}`,
              },
              body: formData,
            });

            if (!response.ok) {
              if (response.status === 401) {
                mostrarFeedback(
                  "üîí Sess√£o expirada. Redirecionando...",
                  "error",
                );
                setTimeout(() => fazerLogout(), 2000);
                return;
              }

              const errorData = await response.json();
              throw new Error(errorData.error || "Falha ao cadastrar produto");
            }

            const result = await response.json();
            const produtoId = result.produto_id;

            mostrarFeedback("‚úÖ Produto cadastrado com sucesso!", "success");
            this.reset();
            removerImagem();
            carregarProdutos();
            resetIdleTimer(); // Resetar timer ap√≥s a√ß√£o
          } catch (error) {
            console.error("Erro ao cadastrar produto:", error);
            mostrarFeedback(
              "‚ùå Erro ao cadastrar produto: " + error.message,
              "error",
            );
          } finally {
            button.innerHTML = originalText;
            button.disabled = false;
          }
        });

      function mostrarFeedback(mensagem, tipo) {
        // Remover feedback anterior se existir
        const feedbackAnterior = document.querySelector(".form-feedback");
        if (feedbackAnterior) {
          feedbackAnterior.remove();
        }

        const cores = {
          success: "from-green-500 to-emerald-600",
          error: "from-red-500 to-rose-600",
          warning: "from-yellow-500 to-amber-600",
          info: "from-blue-500 to-cyan-600",
        };

        const icones = {
          success: "check",
          error: "alert-triangle",
          warning: "alert-circle",
          info: "info",
        };

        const feedback = document.createElement("div");
        feedback.className = `form-feedback fixed top-4 right-4 z-50 p-4 rounded-xl shadow-lg transform translate-x-full transition-transform duration-300 bg-gradient-to-r ${
          cores[tipo] || "from-gray-500 to-gray-600"
        } text-white`;
        feedback.innerHTML = `
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mr-3">
                        <i data-feather="${
                          icones[tipo] || "info"
                        }" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="font-semibold">${mensagem}</p>
                    </div>
                </div>
            `;

        document.body.appendChild(feedback);
        feather.replace();

        // Animate in
        setTimeout(() => feedback.classList.remove("translate-x-full"), 100);

        // Remove after delay
        setTimeout(() => {
          feedback.classList.add("translate-x-full");
          setTimeout(() => feedback.remove(), 300);
        }, 4000);
      }

      // NOVO: Fun√ß√£o para transformar URLs em links clic√°veis na descri√ß√£o
      function formatarDescricaoComLinks(texto) {
        if (!texto) {
          return "Sem descri√ß√£o";
        }
        // Regex para encontrar URLs
        const urlRegex = /(https?:\/\/[^\s"'<>`]+)/g;
        return texto.replace(
          urlRegex,
          // Adicionado event.stopPropagation() para evitar conflitos no painel admin
          '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-pink-500 hover:underline" onclick="event.stopPropagation();">$1</a>',
        );
      }

      // Carregar produtos
      async function carregarProdutos() {
        const lista = document.getElementById("listaProdutos");
        try {
          // Usar a mesma URL da API que o index.html usa
          const baseUrl =
            typeof API_BASE_URL !== "undefined" ? API_BASE_URL : "";
          const url = baseUrl ? `${baseUrl}/api/produtos` : "/api/produtos";
          const response = await fetch(url);
          if (!response.ok) throw new Error("Falha ao buscar produtos");

          const produtos = await response.json();

          document.getElementById("totalProdutos").textContent = `${
            produtos.length
          } produto${produtos.length !== 1 ? "s" : ""}`;

          if (produtos.length === 0) {
            lista.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">üìù</div>
                            <p>Nenhum produto cadastrado ainda</p>
                            <p class="text-sm mt-2">Use o formul√°rio acima para adicionar seu primeiro produto!</p>
                        </div>
                    `;
            return;
          }

          lista.innerHTML = produtos
            .map((produto) => {
              const temImagem = !!produto.imagem_url;
              // Reconstr√≥i a URL completa se for um caminho relativo (upload local)
              let imagemSrc = produto.imagem_url || "";
              if (imagemSrc && imagemSrc.startsWith("/")) {
                const baseUrl =
                  typeof API_BASE_URL !== "undefined" ? API_BASE_URL : "";
                imagemSrc = `${baseUrl}${imagemSrc}`;
              }

              return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition group">
                        <div class="flex items-center space-x-4">
                            ${
                              temImagem
                                ? `<div class="w-20 h-20 flex-shrink-0">
                                    <img src="${imagemSrc}" 
                                         class="w-full h-full object-cover rounded-lg shadow-sm"
                                         loading="lazy"
                                         crossorigin="anonymous"
                                         alt="${produto.nome}">
                                </div>`
                                : `<div class="w-20 h-20 ${
                                    produto.cor_gradiente || "bg-gray-100"
                                  } rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-feather="${
                                      produto.icone || "gift"
                                    }" class="w-8 h-8 text-white"></i>
                                </div>`
                            }
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-semibold text-lg text-gray-800">${
                                          produto.nome
                                        }</h3>
                                        <p class="text-gray-600 text-sm mt-1 line-clamp-2">${formatarDescricaoComLinks(produto.descricao)}</p>
                                    </div>
                                    <button onclick="removerProduto('${
                                      produto.id
                                    }')" 
                                            class="text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity"
                                            title="Remover produto">
                                        <i data-feather="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div class="flex items-center space-x-4 mt-2">
                                    <span class="text-pink-600 font-bold">R$ ${produto.preco
                                      .toFixed(2)
                                      .replace(".", ",")}</span>
                                    <span class="bg-${
                                      produto.cor || "gray"
                                    }-100 text-${
                                      produto.cor || "gray"
                                    }-600 text-xs px-2 py-1 rounded-full whitespace-nowrap flex-shrink-0">${
                                      produto.categoria
                                    }</span>
                                    ${
                                      produto.desconto > 0
                                        ? `<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${produto.desconto}% OFF</span>`
                                        : ""
                                    }
                                </div>
                                <div class="flex space-x-2 mt-2">
                                    ${
                                      produto.novo
                                        ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Novo</span>'
                                        : ""
                                    }
                                    ${
                                      produto.mais_vendido
                                        ? '<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs">Mais Vendido</span>'
                                        : ""
                                    }
                                    <span class="text-xs text-gray-400">
                                        ID: ${
                                          produto.id
                                            ? produto.id.slice(-6)
                                            : "N/A"
                                        }
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
            })
            .join("");

          feather.replace();
          resetIdleTimer(); // Resetar timer ap√≥s carregar produtos
        } catch (error) {
          console.error("Erro ao carregar produtos:", error);
          lista.innerHTML = `<div class="text-center py-8 text-red-500">
               <i data-feather="alert-circle" class="w-12 h-12 mx-auto mb-2"></i>
               <p class="font-medium">Erro ao conectar com o servidor.</p>
               <p class="text-sm mt-1">Verifique se o backend est√° rodando (node server.js)</p>
             </div>`;
          feather.replace();
        }
      }

      // Carregar pedidos
      async function carregarPedidos() {
        const lista = document.getElementById("listaPedidos");

        // Estado de loading
        lista.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent text-pink-600 rounded-full mb-2" role="status" aria-label="loading"></div>
                <p>Buscando pedidos...</p>
            </div>`;

        try {
          const baseUrl =
            typeof API_BASE_URL !== "undefined" ? API_BASE_URL : "";
          const url = `${baseUrl}/api/pedidos`;

          const response = await fetch(url, {
            headers: {
              Authorization: `Bearer ${adminToken}`,
            },
          });

          if (!response.ok) {
            if (response.status === 401) return; // Auth error handled globally usually
            throw new Error("Falha ao buscar pedidos");
          }

          const pedidos = await response.json();

          if (pedidos.length === 0) {
            lista.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üì≠</div>
                    <p>Nenhum pedido recebido ainda</p>
                </div>
            `;
            return;
          }

          lista.innerHTML = pedidos
            .map((pedido) => {
              const data = new Date(pedido.dataCriacao).toLocaleString("pt-BR");
              const total =
                typeof pedido.total === "number"
                  ? pedido.total.toFixed(2).replace(".", ",")
                  : "0,00";

              // Formatar itens
              const itensHtml = Array.isArray(pedido.itens)
                ? pedido.itens
                    .map(
                      (item) =>
                        `<li class="text-sm text-gray-600 flex justify-between border-b border-gray-50 last:border-0 py-1">
                    <span><span class="font-bold text-pink-600">${item.quantidade}x</span> ${item.nome}</span>
                 </li>`,
                    )
                    .join("")
                : '<li class="text-sm text-gray-500">Sem itens</li>';

              return `
                <div class="border border-gray-200 rounded-lg p-5 hover:shadow-md transition bg-gray-50">
                    <div class="flex flex-col md:flex-row justify-between gap-6">
                        <!-- Info Principal -->
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="bg-pink-100 text-pink-800 text-xs font-bold px-3 py-1 rounded-full">${pedido.numero_pedido || "#???"}</span>
                                <span class="text-xs text-gray-500 flex items-center bg-white px-2 py-1 rounded border border-gray-100">
                                    <i data-feather="calendar" class="w-3 h-3 mr-1"></i> ${data}
                                </span>
                            </div>
                            <h3 class="font-bold text-lg text-gray-800 mb-1">${pedido.cliente_nome}</h3>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p class="flex items-center"><i data-feather="phone" class="w-3 h-3 mr-2 text-gray-400"></i> ${pedido.cliente_telefone || "N√£o informado"}</p>
                                <p class="flex items-center"><i data-feather="map-pin" class="w-3 h-3 mr-2 text-gray-400"></i> ${pedido.endereco_entrega || "Retirada"}</p>
                            </div>
                            ${pedido.observacoes ? `<div class="mt-3 text-sm text-amber-700 bg-amber-50 p-3 rounded-lg border border-amber-100"><span class="font-bold">Obs:</span> ${pedido.observacoes}</div>` : ""}
                        </div>

                        <!-- Itens e Total -->
                        <div class="flex-1 md:max-w-md bg-white p-4 rounded-lg border border-gray-100 shadow-sm">
                            <h4 class="font-semibold text-xs text-gray-400 uppercase tracking-wider mb-3">Resumo do Pedido</h4>
                            <ul class="space-y-1 mb-4 max-h-40 overflow-y-auto pr-2">
                                ${itensHtml}
                            </ul>
                            <div class="flex justify-between items-center border-t border-gray-100 pt-3 mt-auto">
                                <span class="font-bold text-gray-700">Total Final</span>
                                <span class="font-bold text-xl text-green-600">R$ ${total}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            })
            .join("");

          feather.replace();
        } catch (error) {
          console.error("Erro ao carregar pedidos:", error);
          lista.innerHTML = `<div class="text-center py-4 text-red-500 bg-red-50 rounded-lg border border-red-100">
            <p class="font-bold">Erro ao carregar pedidos</p>
            <p class="text-sm">${error.message}</p>
          </div>`;
        }
      }

      // Fun√ß√£o para deletar todos os pedidos com senha de seguran√ßa
      async function deletarTodosPedidos() {
        const senha = prompt(
          "‚ö†Ô∏è PERIGO: Isso apagar√° TODOS os pedidos permanentemente!\n\nPara confirmar, digite a senha de administrador:",
        );

        // Senha de seguran√ßa (mesma do login.html)
        const SENHA_ADMIN = "graca123";

        if (senha === SENHA_ADMIN) {
          if (
            !confirm("Tem certeza absoluta? Essa a√ß√£o n√£o pode ser desfeita.")
          )
            return;

          try {
            const baseUrl =
              typeof API_BASE_URL !== "undefined" ? API_BASE_URL : "";
            const url = `${baseUrl}/api/pedidos`;

            const response = await fetch(url, {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${adminToken}`,
              },
            });

            if (!response.ok) throw new Error("Falha ao deletar pedidos");

            mostrarFeedback(
              "‚úÖ Hist√≥rico de pedidos limpo com sucesso!",
              "success",
            );
            carregarPedidos();
          } catch (error) {
            console.error("Erro ao limpar pedidos:", error);
            mostrarFeedback("‚ùå Erro ao limpar pedidos", "error");
          }
        } else if (senha !== null) {
          alert("‚õî Senha incorreta! A√ß√£o cancelada.");
        }
      }

      async function removerProduto(id) {
        if (confirm("Tem certeza que deseja remover este produto?")) {
          try {
            const baseUrl =
              typeof API_BASE_URL !== "undefined" ? API_BASE_URL : "";
            const url = baseUrl
              ? `${baseUrl}/api/produtos/${id}`
              : `/api/produtos/${id}`;
            const response = await fetch(url, {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${adminToken}`,
              },
            });

            if (!response.ok) {
              if (response.status === 401) {
                mostrarFeedback(
                  "üîí Sess√£o expirada. Redirecionando...",
                  "error",
                );
                setTimeout(() => fazerLogout(), 2000);
                return;
              }

              const errorData = await response.json();
              throw new Error(errorData.error || "Falha ao remover produto");
            }

            mostrarFeedback("‚úÖ Produto removido com sucesso!", "success");
            carregarProdutos();
            resetIdleTimer(); // Resetar timer ap√≥s a√ß√£o
          } catch (error) {
            console.error("Erro ao remover produto:", error);
            mostrarFeedback(
              "‚ùå Erro ao remover produto: " + error.message,
              "error",
            );
          }
        }
      }

      // Carregar produtos ao iniciar
      carregarProdutos();
      carregarPedidos(); // Iniciar carregamento de pedidos

      // Adicionar bot√£o de logout tamb√©m no mobile se necess√°rio
      document.addEventListener("DOMContentLoaded", function () {
        // Garantir que o bot√£o de logout funcione
        const logoutLink = document.querySelector('a[onclick*="fazerLogout"]');
        if (logoutLink) {
          logoutLink.addEventListener("click", function (e) {
            e.preventDefault();
            fazerLogout();
          });
        }

        inicializarMobileMenu();
      });

      function inicializarMobileMenu() {
        const menuButton = document.getElementById("mobile-menu-button");
        const mobileMenu = document.getElementById("mobile-menu");

        if (menuButton && mobileMenu) {
          menuButton.addEventListener("click", () => {
            mobileMenu.classList.toggle("hidden");
            const icon = menuButton.querySelector("i");
            if (icon) {
              icon.setAttribute(
                "data-feather",
                mobileMenu.classList.contains("hidden") ? "menu" : "x",
              );
              feather.replace();
            }
          });

          document.addEventListener("click", (e) => {
            if (
              !menuButton.contains(e.target) &&
              !mobileMenu.contains(e.target)
            ) {
              mobileMenu.classList.add("hidden");
              menuButton
                .querySelector("i")
                ?.setAttribute("data-feather", "menu");
              feather.replace();
            }
          });
        }
      }
    </script>
  </body>
</html>
