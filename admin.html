<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Administrativo - Gra√ßa Presentes</title>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link rel="stylesheet" href="/style/style.css" />
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header
      class="gradient-bg shadow-sm sticky top-0 z-50 backdrop-blur-sm bg-white/95"
    >
      <div
        class="container mx-auto px-4 py-3 flex justify-between items-center"
      >
        <!-- Logo -->
        <div class="flex items-center">
          <div
            class="w-12 h-12 rounded-full bg-pink-100 flex items-center justify-center mr-3 transition-transform hover:scale-105"
          >
            <i data-feather="gift" class="text-pink-600 w-6 h-6"></i>
          </div>
          <h1 class="text-2xl font-bold text-pink-600 font-serif">
            Gra√ßa Presentes
          </h1>
        </div>

        <nav class="hidden md:block">
          <ul class="flex space-x-8">
            <li>
              <a
                href="javascript:void(0)"
                onclick="fazerLogout()"
                class="nav-link font-medium hover:text-pink-600 transition"
                >Sair</a
              >
            </li>
            <li>
              <a
                href="produtos.html"
                class="nav-link font-medium hover:text-pink-600 transition"
                >Ver Loja</a
              >
            </li>
          </ul>
        </nav>

        <!-- Mobile Menu Button -->
        <button
          class="md:hidden p-2 rounded-full hover:bg-pink-100 transition"
          id="mobile-menu-button"
        >
          <i data-feather="menu"></i>
        </button>
      </div>

      <!-- Mobile Menu -->
      <div
        class="md:hidden hidden bg-white/95 backdrop-blur-sm shadow-xl border-t"
        id="mobile-menu"
      >
        <div class="container mx-auto px-4 py-4">
          <ul class="space-y-3">
            <li>
              <a
                href="produtos.html"
                class="block py-3 font-medium text-gray-600 hover:text-pink-600 transition pl-4"
                >Ver Loja</a
              >
            </li>
            <li>
              <a
                href="javascript:void(0)"
                onclick="fazerLogout()"
                class="block py-3 font-medium text-gray-600 hover:text-pink-600 transition pl-4"
                >Sair</a
              >
            </li>
          </ul>
        </div>
      </div>
    </header>

    <div class="container mx-auto px-4 py-8">
      <!-- Cabe√ßalho -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-pink-600">üéÅ Gra√ßa Presentes</h1>
        <p class="text-gray-600">
          Painel Administrativo - Cadastro de Produtos
        </p>
      </div>

      <!-- Formul√°rio de Cadastro -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">
          ‚ûï Adicionar Novo Produto
        </h2>

        <form id="produtoForm" class="space-y-6">
          <!-- Informa√ß√µes B√°sicas -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >üìù Nome do Produto *</label
              >
              <input
                type="text"
                name="nome"
                required
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                placeholder="Ex: Buqu√™ de Rosas Vermelhas"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >üìÇ Categoria *</label
              >
              <select
                name="categoria"
                required
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
              >
                <option value="">Selecione uma categoria</option>
                <option value="Flores">üå∑ Flores</option>
                <option value="Doces">üç´ Doces</option>
                <option value="Pel√∫cias">üß∏ Pel√∫cias</option>
                <option value="Cosm√©ticos">üíÑ Cosm√©ticos</option>
                <option value="Kits">üéÅ Kits</option>
                <option value="Decora√ß√£o">üè† Decora√ß√£o</option>
                <option value="Joias">üíé Joias</option>
                <option value="Rom√¢nticos">‚ù§Ô∏è Rom√¢nticos</option>
              </select>
            </div>
          </div>

          <!-- Pre√ßos -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >üí∞ Pre√ßo (R$) *</label
              >
              <input
                type="number"
                step="0.01"
                name="preco"
                required
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                placeholder="89.90"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >üè∑Ô∏è Pre√ßo Original (opcional)</label
              >
              <input
                type="number"
                step="0.01"
                name="precoOriginal"
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                placeholder="99.90"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >üéØ Desconto (%)</label
              >
              <input
                type="number"
                name="desconto"
                min="0"
                max="100"
                value="0"
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
              />
            </div>
          </div>

          <!-- Descri√ß√£o -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >üìÑ Descri√ß√£o do Produto</label
            >
            <textarea
              name="descricao"
              rows="3"
              class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
              placeholder="Descreva o produto detalhadamente..."
            ></textarea>
          </div>

          <!-- Upload de Imagem -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >üñºÔ∏è Imagem do Produto (opcional)</label
            >
            <div
              class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center transition-colors hover:border-pink-400"
            >
              <input
                type="file"
                id="imagemInput"
                accept="image/*"
                class="hidden"
                onchange="previewImagem(event)"
              />

              <div id="uploadArea" class="cursor-pointer">
                <div class="mx-auto w-12 h-12 text-gray-400 mb-3">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                    ></path>
                  </svg>
                </div>
                <p class="text-gray-600">Clique para selecionar uma imagem</p>
                <p class="text-sm text-gray-500 mt-1">PNG, JPG, JPEG at√© 5MB</p>
              </div>

              <!-- Preview da Imagem -->
              <div id="previewContainer" class="hidden mt-4">
                <div class="image-preview-container">
                  <img
                    id="imagemPreview"
                    class="mx-auto max-h-48 rounded-lg shadow-md object-cover"
                  />
                  <div
                    class="remove-image-btn"
                    onclick="removerImagem()"
                    title="Remover imagem"
                  >
                    √ó
                  </div>
                </div>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2">
              Dica: Use imagens quadradas (1:1) para melhor visualiza√ß√£o
            </p>
          </div>

          <!-- Op√ß√µes -->
          <div class="flex items-center space-x-6">
            <div class="flex items-center">
              <input
                type="checkbox"
                name="novo"
                id="novo"
                class="w-4 h-4 text-pink-600 focus:ring-pink-500"
              />
              <label for="novo" class="ml-2 text-sm text-gray-700"
                >üÜï Produto Novo</label
              >
            </div>

            <div class="flex items-center">
              <input
                type="checkbox"
                name="maisVendido"
                id="maisVendido"
                class="w-4 h-4 text-pink-600 focus:ring-pink-500"
              />
              <label for="maisVendido" class="ml-2 text-sm text-gray-700"
                >üî• Mais Vendido</label
              >
            </div>
          </div>

          <!-- Bot√£o Submit -->
          <button
            type="submit"
            class="w-full bg-gradient-to-r from-pink-500 to-rose-500 text-white py-3 px-6 rounded-lg hover:from-pink-600 hover:to-rose-600 transition duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
          >
            üöÄ Cadastrar Produto
          </button>
        </form>
      </div>

      <!-- Lista de Produtos -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-semibold text-gray-800">
            üì¶ Produtos Cadastrados
          </h2>
          <div class="flex items-center space-x-3">
            <span
              id="totalProdutos"
              class="bg-pink-100 text-pink-800 px-3 py-1 rounded-full text-sm font-medium"
              >0 produtos</span
            >
            <button
              onclick="exportarProdutos()"
              class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium hover:bg-green-200 transition"
            >
              üì§ Exportar
            </button>
          </div>
        </div>

        <div id="listaProdutos" class="space-y-4">
          <!-- Produtos ser√£o carregados aqui -->
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">üìù</div>
            <p>Nenhum produto cadastrado ainda</p>
          </div>
        </div>
      </div>
    </div>

    <style>
      /* Estilos para o preview da imagem */
      .image-preview-container {
        position: relative;
        display: inline-block;
      }
      .remove-image-btn {
        position: absolute;
        top: -10px;
        right: -10px;
        background-color: rgba(239, 68, 68, 0.9); /* red-500 */
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
    </style>

    <script>
      // Verificar se o usu√°rio est√° logado
      const adminToken = localStorage.getItem("admin_token");
      if (!adminToken) {
        // Redirecionar para tela de login se n√£o estiver logado
        window.location.href = "login.html";
      }

      feather.replace();

      // Vari√°vel para armazenar a imagem em Base64
      let imagemBase64 = null;

      // Fun√ß√£o para fazer logout seguro
      function fazerLogout() {
        // Remover token de autentica√ß√£o
        localStorage.removeItem("admin_token");

        // Limpar dados da sess√£o administrativa
        sessionStorage.clear();

        // Opcional: Limpar tamb√©m o carrinho (se quiser)
        // localStorage.removeItem('carrinho');

        // Redirecionar para a p√°gina inicial
        mostrarFeedback("üîí Saindo do sistema...", "info");
        setTimeout(() => {
          window.location.href = "index.html";
        }, 1000);
      }

      // Sistema de timeout de sess√£o (30 minutos)
      let idleTimer;
      function resetIdleTimer() {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(() => {
          // Verificar se ainda est√° autenticado
          const token = localStorage.getItem("admin_token");
          if (token) {
            mostrarFeedback(
              "‚è∞ Sess√£o expirada por inatividade. Redirecionando...",
              "warning"
            );
            setTimeout(() => {
              fazerLogout();
            }, 2000);
          }
        }, 30 * 60 * 1000); // 30 minutos
      }

      // Iniciar timer de inatividade ao carregar a p√°gina
      resetIdleTimer();

      // Resetar timer em eventos de intera√ß√£o
      ["click", "mousemove", "keypress", "scroll"].forEach((event) => {
        document.addEventListener(event, resetIdleTimer, { passive: true });
      });

      // Detectar quando a p√°gina perde o foco (usu√°rio sai)
      window.addEventListener("blur", function () {
        // N√£o fazer logout imediato, apenas registrar
        console.log("P√°gina perdeu foco");
      });

      // Detectar quando a p√°gina volta a ter foco
      window.addEventListener("focus", function () {
        // Verificar se o token ainda existe
        const token = localStorage.getItem("admin_token");
        if (!token) {
          mostrarFeedback(
            "üîí Sess√£o expirada. Redirecionando para login...",
            "warning"
          );
          setTimeout(() => {
            window.location.href = "login.html";
          }, 1500);
        } else {
          resetIdleTimer(); // Resetar timer de inatividade
        }
      });

      // Detectar quando o usu√°rio est√° saindo da p√°gina (fechando aba/janela)
      window.addEventListener("beforeunload", function (e) {
        // N√£o fazer nada especial para n√£o interferir na navega√ß√£o
        // O token permanecer√° no localStorage at√© expirar ou ser removido manualmente
      });

      // Fun√ß√µes para manipula√ß√£o de imagem
      function previewImagem(event) {
        const file = event.target.files[0];
        if (file) {
          // Verificar tamanho (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            mostrarFeedback("‚ùå A imagem deve ter no m√°ximo 5MB", "error");
            return;
          }

          // Verificar tipo
          if (!file.type.match("image.*")) {
            mostrarFeedback(
              "‚ùå Por favor, selecione apenas arquivos de imagem",
              "error"
            );
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            imagemBase64 = e.target.result;

            // Mostrar preview
            const previewImg = document.getElementById("imagemPreview");
            previewImg.src = imagemBase64;

            // Mostrar container do preview
            document
              .getElementById("previewContainer")
              .classList.remove("hidden");
            document.getElementById("uploadArea").classList.add("hidden");
          };
          reader.readAsDataURL(file);
        }
      }

      function removerImagem() {
        imagemBase64 = null;
        document.getElementById("imagemInput").value = "";
        document.getElementById("previewContainer").classList.add("hidden");
        document.getElementById("uploadArea").classList.remove("hidden");
      }

      // Permitir clicar na √°rea de upload
      document
        .getElementById("uploadArea")
        .addEventListener("click", function () {
          document.getElementById("imagemInput").click();
        });

      // Cadastrar produto
      document
        .getElementById("produtoForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const button = this.querySelector('button[type="submit"]');
          const originalText = button.innerHTML;
          button.innerHTML = "‚è≥ Cadastrando...";
          button.disabled = true;

          const formData = new FormData(this);
          const produtoData = {
            nome: formData.get("nome"),
            preco: parseFloat(formData.get("preco")),
            preco_original: formData.get("precoOriginal")
              ? parseFloat(formData.get("precoOriginal"))
              : null,
            categoria: formData.get("categoria"),
            descricao: formData.get("descricao"),
            desconto: parseInt(formData.get("desconto") || 0),
            novo: document.getElementById("novo").checked,
            mais_vendido: document.getElementById("maisVendido").checked,
          };

          try {
            // Usar a mesma URL da API que o index.html usa
            const url = API_BASE_URL
              ? `${API_BASE_URL}/api/produtos`
              : "/api/produtos";

            // 1. Enviar dados do produto para a API
            const response = await fetch(url, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${adminToken}`,
              },
              body: JSON.stringify(produtoData),
            });

            if (!response.ok) {
              if (response.status === 401) {
                mostrarFeedback(
                  "üîí Sess√£o expirada. Redirecionando...",
                  "error"
                );
                setTimeout(() => fazerLogout(), 2000);
                return;
              }

              const errorData = await response.json();
              throw new Error(errorData.error || "Falha ao cadastrar produto");
            }

            const result = await response.json();
            const produtoId = result.produto_id;

            // 2. Se houver imagem, fazer upload direto para o Cloudinary
            const imagemFile = document.getElementById("imagemInput").files[0];
            if (imagemFile) {
              // 2.1. Obter assinatura do backend
              const signResponse = await fetch(
                API_BASE_URL
                  ? `${API_BASE_URL}/api/sign-upload`
                  : "/api/sign-upload",
                { headers: { Authorization: `Bearer ${adminToken}` } }
              );
              if (!signResponse.ok)
                throw new Error("Falha ao obter assinatura para upload.");
              const signData = await signResponse.json();

              // 2.2. Montar formul√°rio de upload para o Cloudinary
              const uploadFormData = new FormData();
              uploadFormData.append("file", imagemFile);
              uploadFormData.append("api_key", signData.api_key);
              uploadFormData.append("timestamp", signData.timestamp);
              uploadFormData.append("signature", signData.signature);
              uploadFormData.append("folder", signData.folder);

              // 2.3. Enviar para a API do Cloudinary
              const cloudinaryUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
              const cloudinaryResponse = await fetch(cloudinaryUrl, {
                method: "POST",
                body: uploadFormData,
              });

              if (!cloudinaryResponse.ok) {
                throw new Error(
                  "Produto salvo, mas falha ao enviar imagem para o Cloudinary."
                );
              }
              const cloudinaryResult = await cloudinaryResponse.json();

              // 2.4. Enviar URL da imagem para o nosso backend para salvar no produto
              const updateImageUrl = API_BASE_URL
                ? `${API_BASE_URL}/api/upload-imagem`
                : "/api/upload-imagem";
              await fetch(updateImageUrl, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${adminToken}`,
                },
                body: JSON.stringify({
                  produto_id: produtoId,
                  imagem_url: cloudinaryResult.secure_url,
                  cloudinary_public_id: cloudinaryResult.public_id,
                }),
              });
            }

            mostrarFeedback("‚úÖ Produto cadastrado com sucesso!", "success");
            this.reset();
            removerImagem();
            carregarProdutos();
            resetIdleTimer(); // Resetar timer ap√≥s a√ß√£o
          } catch (error) {
            console.error("Erro ao cadastrar produto:", error);
            mostrarFeedback(
              "‚ùå Erro ao cadastrar produto: " + error.message,
              "error"
            );
          } finally {
            button.innerHTML = originalText;
            button.disabled = false;
          }
        });

      function mostrarFeedback(mensagem, tipo) {
        // Remover feedback anterior se existir
        const feedbackAnterior = document.querySelector(".form-feedback");
        if (feedbackAnterior) {
          feedbackAnterior.remove();
        }

        const cores = {
          success: "from-green-500 to-emerald-600",
          error: "from-red-500 to-rose-600",
          warning: "from-yellow-500 to-amber-600",
          info: "from-blue-500 to-cyan-600",
        };

        const icones = {
          success: "check",
          error: "alert-triangle",
          warning: "alert-circle",
          info: "info",
        };

        const feedback = document.createElement("div");
        feedback.className = `form-feedback fixed top-4 right-4 z-50 p-4 rounded-xl shadow-lg transform translate-x-full transition-transform duration-300 bg-gradient-to-r ${
          cores[tipo] || "from-gray-500 to-gray-600"
        } text-white`;
        feedback.innerHTML = `
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mr-3">
                        <i data-feather="${
                          icones[tipo] || "info"
                        }" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="font-semibold">${mensagem}</p>
                    </div>
                </div>
            `;

        document.body.appendChild(feedback);
        feather.replace();

        // Animate in
        setTimeout(() => feedback.classList.remove("translate-x-full"), 100);

        // Remove after delay
        setTimeout(() => {
          feedback.classList.add("translate-x-full");
          setTimeout(() => feedback.remove(), 300);
        }, 4000);
      }

      // Carregar produtos
      async function carregarProdutos() {
        const lista = document.getElementById("listaProdutos");
        try {
          // Usar a mesma URL da API que o index.html usa
          const url = API_BASE_URL
            ? `${API_BASE_URL}/api/produtos`
            : "/api/produtos";
          const response = await fetch(url);
          if (!response.ok) throw new Error("Falha ao buscar produtos");

          const produtos = await response.json();

          document.getElementById("totalProdutos").textContent = `${
            produtos.length
          } produto${produtos.length !== 1 ? "s" : ""}`;

          if (produtos.length === 0) {
            lista.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">üìù</div>
                            <p>Nenhum produto cadastrado ainda</p>
                            <p class="text-sm mt-2">Use o formul√°rio acima para adicionar seu primeiro produto!</p>
                        </div>
                    `;
            return;
          }

          lista.innerHTML = produtos
            .map((produto) => {
              const temImagem = !!produto.imagem_url;
              // A URL da imagem do Cloudinary j√° √© completa, ent√£o a usamos diretamente.
              const imagemSrc = produto.imagem_url || "";

              return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition group">
                        <div class="flex items-center space-x-4">
                            ${
                              temImagem
                                ? `<div class="w-20 h-20 flex-shrink-0">
                                    <img src="${imagemSrc}" 
                                         class="w-full h-full object-cover rounded-lg shadow-sm"
                                         loading="lazy"
                                         alt="${produto.nome}">
                                </div>`
                                : `<div class="w-20 h-20 ${
                                    produto.cor_gradiente || "bg-gray-100"
                                  } rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-feather="${
                                      produto.icone || "gift"
                                    }" class="w-8 h-8 text-white"></i>
                                </div>`
                            }
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-semibold text-lg text-gray-800">${
                                          produto.nome
                                        }</h3>
                                        <p class="text-gray-600 text-sm mt-1 line-clamp-2">${
                                          produto.descricao || "Sem descri√ß√£o"
                                        }</p>
                                    </div>
                                    <button onclick="removerProduto('${
                                      produto.id
                                    }')" 
                                            class="text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity"
                                            title="Remover produto">
                                        <i data-feather="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div class="flex items-center space-x-4 mt-2">
                                    <span class="text-pink-600 font-bold">R$ ${produto.preco
                                      .toFixed(2)
                                      .replace(".", ",")}</span>
                                    <span class="bg-${
                                      produto.cor || "gray"
                                    }-100 text-${
                produto.cor || "gray"
              }-600 text-xs px-2 py-1 rounded-full whitespace-nowrap flex-shrink-0">${
                produto.categoria
              }</span>
                                    ${
                                      produto.desconto > 0
                                        ? `<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${produto.desconto}% OFF</span>`
                                        : ""
                                    }
                                </div>
                                <div class="flex space-x-2 mt-2">
                                    ${
                                      produto.novo
                                        ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Novo</span>'
                                        : ""
                                    }
                                    ${
                                      produto.mais_vendido
                                        ? '<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs">Mais Vendido</span>'
                                        : ""
                                    }
                                    <span class="text-xs text-gray-400">
                                        ID: ${
                                          produto.id
                                            ? produto.id.slice(-6)
                                            : "N/A"
                                        }
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
            })
            .join("");

          feather.replace();
          resetIdleTimer(); // Resetar timer ap√≥s carregar produtos
        } catch (error) {
          console.error("Erro ao carregar produtos:", error);
          lista.innerHTML =
            '<p class="text-red-500 text-center">Erro ao carregar produtos</p>';
        }
      }

      async function removerProduto(id) {
        if (confirm("Tem certeza que deseja remover este produto?")) {
          try {
            const url = API_BASE_URL
              ? `${API_BASE_URL}/api/produtos/${id}`
              : `/api/produtos/${id}`;
            const response = await fetch(url, {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${adminToken}`,
              },
            });

            if (!response.ok) {
              if (response.status === 401) {
                mostrarFeedback(
                  "üîí Sess√£o expirada. Redirecionando...",
                  "error"
                );
                setTimeout(() => fazerLogout(), 2000);
                return;
              }

              const errorData = await response.json();
              throw new Error(errorData.error || "Falha ao remover produto");
            }

            mostrarFeedback("‚úÖ Produto removido com sucesso!", "success");
            carregarProdutos();
            resetIdleTimer(); // Resetar timer ap√≥s a√ß√£o
          } catch (error) {
            console.error("Erro ao remover produto:", error);
            mostrarFeedback(
              "‚ùå Erro ao remover produto: " + error.message,
              "error"
            );
          }
        }
      }

      async function exportarProdutos() {
        try {
          const url = API_BASE_URL
            ? `${API_BASE_URL}/api/produtos`
            : "/api/produtos";
          const response = await fetch(url);
          if (!response.ok)
            throw new Error("Falha ao buscar produtos para exporta√ß√£o");
          const produtos = await response.json();

          const dadosString = JSON.stringify(produtos, null, 2);
          const blob = new Blob([dadosString], { type: "application/json" });
          const urlObject = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = urlObject;
          a.download = `produtos_graca_presentes_${
            new Date().toISOString().split("T")[0]
          }.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(urlObject);

          mostrarFeedback("‚úÖ Produtos exportados com sucesso!", "success");
          resetIdleTimer(); // Resetar timer ap√≥s a√ß√£o
        } catch (error) {
          mostrarFeedback(`‚ùå ${error.message}`, "error");
        }
      }

      // Carregar produtos ao iniciar
      carregarProdutos();

      // Adicionar bot√£o de logout tamb√©m no mobile se necess√°rio
      document.addEventListener("DOMContentLoaded", function () {
        // Garantir que o bot√£o de logout funcione
        const logoutLink = document.querySelector('a[onclick*="fazerLogout"]');
        if (logoutLink) {
          logoutLink.addEventListener("click", function (e) {
            e.preventDefault();
            fazerLogout();
          });
        }

        inicializarMobileMenu();
      });

      function inicializarMobileMenu() {
        const menuButton = document.getElementById("mobile-menu-button");
        const mobileMenu = document.getElementById("mobile-menu");

        if (menuButton && mobileMenu) {
          menuButton.addEventListener("click", () => {
            mobileMenu.classList.toggle("hidden");
            const icon = menuButton.querySelector("i");
            if (icon) {
              icon.setAttribute(
                "data-feather",
                mobileMenu.classList.contains("hidden") ? "menu" : "x"
              );
              feather.replace();
            }
          });

          document.addEventListener("click", (e) => {
            if (
              !menuButton.contains(e.target) &&
              !mobileMenu.contains(e.target)
            ) {
              mobileMenu.classList.add("hidden");
              menuButton
                .querySelector("i")
                ?.setAttribute("data-feather", "menu");
              feather.replace();
            }
          });
        }
      }
    </script>
  </body>
</html>
